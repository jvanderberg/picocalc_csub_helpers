# PicoMite CSUB helpers

This directory holds a sample CSUB (`pow_int_cf.c`) and helper scripts to build and package
native routines for PicoMite MMBasic.

## Files

- `pow_int_cf.c` – sample routine that raises an integer base to an integer exponent
  (negative exponents return 0).
- `mandelbrot_cf.c` – computes Mandelbrot escape iterations using Q3.28 fixed-point math;
  inputs are scaled integers and the results are written into the first integer argument (array).
- `build.sh` – cross-compiles the given C source into `.elf`, `.bin`, and `.hex` artefacts using
  the ARM bare-metal toolchain (compiled for the RP2350’s Cortex-M33 core, with per-function
  sections disabled so legacy tools such as `armcfgen.bas` can read the `.elf`).
- `emit_cfunction_block.sh` – reads a raw `.bin`, prepends the mandatory entry-offset word
  (`00000000` for simple routines), byte-swaps each 32-bit instruction, and emits a ready-to-paste
  `CSUB … End CSUB` block.
- `test_pow.bas` – minimal BASIC program showing where to paste the generated hex lines for
  `pow_int`.
- `test_mandel.bas` – demonstrates calling the Mandelbrot CSUB over a small sample set.

## Prerequisites

Install the ARM bare-metal toolchain so `arm-none-eabi-gcc` and `arm-none-eabi-objcopy` are on
`PATH` (e.g. `brew install arm-none-eabi-gcc`). The helper uses `python3`; ensure it is
available. `xxd` (from Vim) is only needed if you look at the `.hex` dump.

## Building the sample

```sh
cd cfunc
./build.sh              # builds pow_int_cf.c by default
# or ./build.sh myfunc.c
```

Outputs:

- `pow_int_cf.elf` – relocatable ELF object (compatible with `armcfgen.bas`).
- `pow_int_cf.bin` – raw machine code to embed in BASIC.
- `pow_int_cf.hex` – hex dump (optional reference).

## Generating the BASIC block

```sh
./emit_cfunction_block.sh pow_int_cf.bin "pow_int integer, integer, integer"
```

The script prints something like:

```
CSUB pow_int integer, integer, integer
 00000000
  4604B530 0F4B5A18 8446054B 1B681370
  ...
End CSUB
```

Paste the entire block (replacing the placeholder line inside `test_pow.bas`) into your program
via `AUTOSAVE` or `XMODEM RECEIVE`. **Do not add comments or text between `CSUB …` and `End CSUB`;**
only the hex lines generated by the script should appear there.

After loading the program, you can call the CSUB like a command, passing the destination variable
as the first argument:

```basic
Dim r%
pow_int r%, 2, 10
Print r%
```

Whenever you rebuild the `.bin`, re-run the script and paste the new hex lines.

### Mandelbrot example

```sh
./emit_cfunction_block.sh mandelbrot_cf.bin "mandelbrot integer, integer, integer, integer, integer, integer"
```

This produces a block such as:

```
CSUB mandelbrot integer, integer, integer, integer, integer, integer
 00000000
  .... hex words ....
End CSUB
```

Paste it into `test_mandel.bas` (replacing the placeholder line). Remember to scale your inputs
to Q3.28 before calling, e.g.:

```basic
Const SCALE = 268435456 ' 1 << 28
mandelbrot result%(), CLng(-2 * SCALE), CLng(0 * SCALE), CLng(0.25 * SCALE), points%, max_iter%
```

Then iterate through `result%()` to inspect the iteration counts.
